{"ast":null,"code":"import _asyncToGenerator from \"C:/projects/gazprom/formApplication/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _slicedToArray from \"C:/projects/gazprom/formApplication/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";\nimport \"regenerator-runtime/runtime.js\";\nimport \"core-js/modules/es.object.keys.js\";\nimport \"core-js/modules/es.object.to-string.js\";\nimport \"core-js/modules/web.dom-collections.iterator.js\";\nimport \"core-js/modules/es.object.entries.js\";\nimport \"core-js/modules/es.array.concat.js\";\nimport flatten from 'flat';\nimport useEmail from '@/compositions/useEmail';\nimport useUserData from '@/compositions/useUserData';\nimport useAddress from '@/compositions/useAddress';\nimport usePreloadForm from '@/compositions/usePreloadForm';\nimport { useForm } from 'vee-validate';\nimport { useStore } from 'vuex';\nimport { nextTick, ref } from 'vue';\nimport usePasteAddress from './usePasteAddress';\n\nfunction scrollToFirstError(errors) {\n  var errList = Object.keys(errors);\n  if (errList.length <= 0) return;\n  var el = document.getElementById(errList[0]);\n  var elToScroll = el.parentElement.previousSibling;\n  if (!elToScroll) return;\n  elToScroll.scrollIntoView({\n    behavior: 'smooth'\n  });\n}\n\nexport default function () {\n  var initialValues = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n  var _ref = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {},\n      _ref$social = _ref.social,\n      social = _ref$social === void 0 ? false : _ref$social;\n\n  var loading = ref(false);\n  var submitModal = ref(false);\n  var store = useStore();\n\n  var _useForm = useForm(),\n      values = _useForm.values,\n      validate = _useForm.validate,\n      setErrors = _useForm.setErrors,\n      resetForm = _useForm.resetForm,\n      setFieldValue = _useForm.setFieldValue,\n      setValues = _useForm.setValues;\n\n  nextTick(function () {\n    return resetForm({\n      values: initialValues\n    });\n  });\n  var id = usePreloadForm(setValues); //usePasteAddress(() => values.personal_data.mailing_address, setFieldValue);\n\n  var _useUserData = useUserData(),\n      getUserData = _useUserData.getUserData;\n\n  var handleUserData = function handleUserData(userdata) {\n    for (var _i = 0, _Object$entries = Object.entries(userdata); _i < _Object$entries.length; _i++) {\n      var _Object$entries$_i = _slicedToArray(_Object$entries[_i], 2),\n          key = _Object$entries$_i[0],\n          value = _Object$entries$_i[1];\n\n      if (value.length > 0) {\n        setFieldValue(key, value);\n      }\n    }\n  }; // Если в режиме редактирования заявки, то не делаем запрос к данным пользователя, поскольку используем уже введенные данные\n\n\n  if (id <= 0) {\n    getUserData(handleUserData);\n  }\n\n  var _useAddress = useAddress(),\n      getAccountAddress = _useAddress.getAccountAddress;\n\n  var handleAddress = function handleAddress(accountID) {\n    var handleAccountAddress = function handleAccountAddress(address) {\n      setFieldValue(\"address\", address);\n    };\n\n    if (accountID > 0) {\n      getAccountAddress(handleAccountAddress, accountID);\n    } else {\n      setFieldValue(\"address\", \"\");\n    }\n  };\n\n  var handleDateInterval = function handleDateInterval(name, value) {\n    setFieldValue(name, value);\n  };\n\n  var handleResponse = function handleResponse(data) {\n    if (!Array.isArray(data.errors)) {\n      var errors = flatten(data.errors);\n      setErrors(errors);\n      scrollToFirstError(errors);\n    } else {\n      var _data$post;\n\n      submitModal.value = false;\n      console.log('данные ответа', data);\n      alert('Форма успешно отправлена');\n      var postfix = '';\n      if (+(data === null || data === void 0 ? void 0 : (_data$post = data.post) === null || _data$post === void 0 ? void 0 : _data$post.is_letter) === 1) postfix = \"\".concat(data.id, \"/edit/?id=\").concat(data.id, \"&letter=true\"); //Раскоментировать!\n\n      if (social) location.href = '/contract/requests/' + postfix;else location.href = '/contract/requests/' + postfix;\n    }\n  };\n\n  var handleValidForm = /*#__PURE__*/function () {\n    var _ref2 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n      var _yield$validate, errors, valid;\n\n      return regeneratorRuntime.wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              _context.next = 2;\n              return validate();\n\n            case 2:\n              _yield$validate = _context.sent;\n              errors = _yield$validate.errors;\n              valid = _yield$validate.valid;\n\n              if (valid) {\n                _context.next = 7;\n                break;\n              }\n\n              return _context.abrupt(\"return\", scrollToFirstError(errors));\n\n            case 7:\n              submitModal.value = true;\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee);\n    }));\n\n    return function handleValidForm() {\n      return _ref2.apply(this, arguments);\n    };\n  }();\n\n  var onSubmit = /*#__PURE__*/function () {\n    var _ref3 = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n      var opts,\n          _opts$is_draft,\n          is_draft,\n          _opts$is_sign,\n          is_sign,\n          _opts$request_id,\n          request_id,\n          _yield$validate2,\n          errors,\n          valid,\n          data,\n          _args2 = arguments;\n\n      return regeneratorRuntime.wrap(function _callee2$(_context2) {\n        while (1) {\n          switch (_context2.prev = _context2.next) {\n            case 0:\n              opts = _args2.length > 0 && _args2[0] !== undefined ? _args2[0] : {};\n              _opts$is_draft = opts.is_draft, is_draft = _opts$is_draft === void 0 ? 0 : _opts$is_draft, _opts$is_sign = opts.is_sign, is_sign = _opts$is_sign === void 0 ? 0 : _opts$is_sign, _opts$request_id = opts.request_id, request_id = _opts$request_id === void 0 ? 0 : _opts$request_id;\n              submitModal.value = false;\n\n              if (!(is_draft === 0)) {\n                _context2.next = 11;\n                break;\n              }\n\n              _context2.next = 6;\n              return validate();\n\n            case 6:\n              _yield$validate2 = _context2.sent;\n              errors = _yield$validate2.errors;\n              valid = _yield$validate2.valid;\n\n              if (valid) {\n                _context2.next = 11;\n                break;\n              }\n\n              return _context2.abrupt(\"return\", scrollToFirstError(errors));\n\n            case 11:\n              loading.value = true;\n              _context2.next = 14;\n              return store.dispatch('complexForm/create', {\n                id: id,\n                edit: id >= 0 ? true : false,\n                social: social,\n                data: values,\n                meta: {\n                  is_draft: is_draft,\n                  is_sign: is_sign,\n                  request_id: request_id\n                }\n              });\n\n            case 14:\n              data = _context2.sent;\n              handleResponse(data);\n              loading.value = false;\n\n            case 17:\n            case \"end\":\n              return _context2.stop();\n          }\n        }\n      }, _callee2);\n    }));\n\n    return function onSubmit() {\n      return _ref3.apply(this, arguments);\n    };\n  }();\n\n  return {\n    onSubmit: onSubmit,\n    submitModal: submitModal,\n    loading: loading,\n    handleValidForm: handleValidForm,\n    handleAddress: handleAddress,\n    handleDateInterval: handleDateInterval\n  };\n}","map":{"version":3,"sources":["C:/projects/gazprom/formApplication/src/compositions/useComplexForm.js"],"names":["flatten","useEmail","useUserData","useAddress","usePreloadForm","useForm","useStore","nextTick","ref","usePasteAddress","scrollToFirstError","errors","errList","Object","keys","length","el","document","getElementById","elToScroll","parentElement","previousSibling","scrollIntoView","behavior","initialValues","social","loading","submitModal","store","values","validate","setErrors","resetForm","setFieldValue","setValues","id","getUserData","handleUserData","userdata","entries","key","value","getAccountAddress","handleAddress","accountID","handleAccountAddress","address","handleDateInterval","name","handleResponse","data","Array","isArray","console","log","alert","postfix","post","is_letter","location","href","handleValidForm","valid","onSubmit","opts","is_draft","is_sign","request_id","dispatch","edit","meta"],"mappings":"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","sourcesContent":["import flatten from 'flat';\nimport useEmail from '@/compositions/useEmail';\nimport useUserData from '@/compositions/useUserData';\nimport useAddress from '@/compositions/useAddress';\nimport usePreloadForm from '@/compositions/usePreloadForm';\nimport { useForm } from 'vee-validate';\nimport { useStore } from 'vuex';\nimport { nextTick, ref } from 'vue';\nimport usePasteAddress from './usePasteAddress';\n\nfunction scrollToFirstError(errors) {\n  const errList = Object.keys(errors);\n\n  if (errList.length <= 0) return;\n  const el = document.getElementById(errList[0]);\n\n  const elToScroll = el.parentElement.previousSibling;\n\n  if (!elToScroll) return;\n  elToScroll.scrollIntoView({ behavior: 'smooth' });\n}\n\nexport default function (initialValues = {}, { social = false } = {}) {\n  const loading = ref(false);\n  const submitModal = ref(false);\n  const store = useStore();\n\n  const { values, validate, setErrors, resetForm, setFieldValue, setValues } = useForm();\n\n  nextTick(() => resetForm({ values: initialValues }));\n\n  const id = usePreloadForm(setValues);\n\n  //usePasteAddress(() => values.personal_data.mailing_address, setFieldValue);\n\n\n  const { getUserData } = useUserData();\n  const handleUserData = (userdata) => {\n    for (const [key, value] of Object.entries(userdata)) {\n      if (value.length > 0) {\n        setFieldValue(key, value);\n      }\n    }\n  }\n\n  // Если в режиме редактирования заявки, то не делаем запрос к данным пользователя, поскольку используем уже введенные данные\n  if (id <= 0) {\n    getUserData(handleUserData);\n  }\n\n  const { getAccountAddress } = useAddress();\n  const handleAddress = (accountID) => {\n    const handleAccountAddress = (address) => {\n      setFieldValue(\"address\", address);\n    }\n    if (accountID > 0) {\n      getAccountAddress(handleAccountAddress, accountID);\n    } else {\n      setFieldValue(\"address\", \"\");\n    }\n  }\n\n  const handleDateInterval = (name, value) => {\n    setFieldValue(name, value)\n  }\n\n  const handleResponse = (data) => {\n    if (!Array.isArray(data.errors)) {\n      const errors = flatten(data.errors);\n      setErrors(errors);\n      scrollToFirstError(errors);\n    } else {\n      submitModal.value = false;\n      console.log('данные ответа', data);\n      alert('Форма успешно отправлена');\n\n      let postfix = '';\n      if(+data?.post?.is_letter === 1) postfix = `${data.id}/edit/?id=${data.id}&letter=true`;\n\n      //Раскоментировать!\n      if(social) location.href = '/contract/requests/' + postfix;\n      else location.href = '/contract/requests/' + postfix;\n    }\n  };\n\n  const handleValidForm = async () => {\n    const { errors, valid } = await validate();\n\n    if (!valid) return scrollToFirstError(errors);\n\n    submitModal.value = true;\n\n  }\n\n  const onSubmit = async (opts = {}) => {\n    const { is_draft = 0, is_sign = 0, request_id = 0 } = opts;\n\n    submitModal.value = false;\n\n    if (is_draft === 0) {\n      const { errors, valid } = await validate();\n      if (!valid) return scrollToFirstError(errors);\n    }\n\n    loading.value = true;\n\n    const data = await store.dispatch('complexForm/create', {\n      id,\n      edit: id >= 0 ? true : false,\n      social,\n      data: values,\n      meta: { is_draft, is_sign, request_id },\n    });\n\n    handleResponse(data);\n\n    loading.value = false;\n  };\n\n  return {\n    onSubmit,\n    submitModal,\n    loading,\n    handleValidForm,\n    handleAddress,\n    handleDateInterval\n  };\n}\n"]},"metadata":{},"sourceType":"module"}